service: hyfn-admin

frameworkVersion: "3"

provider:
  name: aws
  runtime: nodejs16.x
  profile: default

  region: eu-south-1
  # you can overwrite defaults here
  stage: development

  iam:
    role:
      statements:
        #   - Effect: 'Allow'
        #     Action:
        #       - 's3:PutObject'
        #     Resource: !GetAtt hyfnImagesBucket.Arn
        - Effect: Allow
          Action:
            - "kms:DescribeKey"
            - "kms:Encrypt"
            - "kms:Decrypt"
            - "kms:ReEncrypt*"
            - "kms:GenerateDataKey"
            - "kms:GenerateDataKeyWithoutPlaintext"
          Resource: !ImportValue hyfn-resources-${sls:stage}-paymentSecretKeyARN
        - Effect: Allow
          Action:
            - "sns:SetSMSAttributes"
            - "sns:Publish"
          Resource: "*"

  httpApi:
    cors:
      allowedOrigins:
        #- https://store.hyfn.xyz
        - "*"
      allowedHeaders:
        - Content-Type

      allowedMethods:
        - POST
      # allowCredentials: true
      exposedResponseHeaders:
        - Special-Response-Header
      maxAge: 6000 # In seconds
  environment:
    kmsKeyARN:
      Fn::ImportValue: !Sub "${self:custom.hyfnResources}-${sls:stage}-paymentSecretKeyARN"

plugins:
  - serverless-webpack
  - serverless-dotenv-plugin
  # - serverless-offline
  # - serverless-esbuild

package:
  individually: true

custom:
  hyfnResources: hyfn-resources
  webpack:
    keepOutputDirectory: true

functions:
  createAdminDocument:
    handler: .build/createAdminDocument/createAdminDocument.handler
    events:
      - httpApi:
          method: POST
          path: /admin/createAdminDocument
  getPaymentRequests:
    handler: .build/getPaymentRequests/getPaymentRequests.handler
    events:
      - httpApi:
          method: POST
          path: /admin/getPaymentRequests
  completePaymentRequest:
    handler: .build/completePaymentRequest/completePaymentRequest.handler
    events:
      - httpApi:
          method: POST
          path: /admin/completePaymentRequest
  createPaymentRequestObject:
    handler: .build/createPaymentRequestObject/createPaymentRequestObject.handler
    events:
      - httpApi:
          method: POST
          path: /admin/createPaymentRequestObject
  removeDriverManagementVerification:
    handler: .build/removeDriverManagementVerification/removeDriverManagementVerification.handler
    events:
      - httpApi:
          method: POST
          path: /admin/removeDriverManagementVerification
  verifyDriverManagement:
    handler: .build/verifyDriverManagement/verifyDriverManagement.handler
    events:
      - httpApi:
          method: POST
          path: /admin/verifyDriverManagement
  getDriverManagement:
    handler: .build/getDriverManagement/getDriverManagement.handler
    events:
      - httpApi:
          method: POST
          path: /admin/getDriverManagement
  getUnverifiedDrivers:
    handler: .build/getUnverifiedDrivers/getUnverifiedDrivers.handler
    events:
      - httpApi:
          method: POST
          path: /admin/getUnverifiedDrivers
  getReports:
    handler: .build/getReports/getReports.handler
    events:
      - httpApi:
          method: POST
          path: /admin/getReports
  getAdminDocument:
    handler: .build/getAdminDocument/getAdminDocument.handler
    events:
      - httpApi:
          method: POST
          path: /admin/getAdminDocument
  setDriverAsVerified:
    handler: .build/setDriverAsVerified/setDriverAsVerified.handler
    events:
      - httpApi:
          method: POST
          path: /admin/setDriverAsVerified
